stages:
  - build
  - test
  - publish
  - sync

# ---------------------------------------------------------------------------
# Build
# ---------------------------------------------------------------------------
build:
  stage: build
  tags:
    - main
  image: oven/bun:1
  script:
    - bun install
    - bun run build
  artifacts:
    paths:
      - node_modules/
      - packages/*/dist/
      - packages/*/node_modules/
    expire_in: 10 mins

# ---------------------------------------------------------------------------
# Test
# ---------------------------------------------------------------------------
typecheck:
  stage: test
  tags:
    - main
  image: oven/bun:1
  needs: [build]
  script:
    - bun run --filter '*' typecheck

test:unit:
  stage: test
  tags:
    - main
  image: oven/bun:1
  needs: [build]
  script:
    - bun run test -- --run

# ---------------------------------------------------------------------------
# Publish to npm (on version tags like v0.1.0)
# ---------------------------------------------------------------------------
publish:npm:
  stage: publish
  tags:
    - main
  image: node:20-slim
  needs: [typecheck, test:unit]
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  script:
    - apt-get update -qq && apt-get install -y -qq jq > /dev/null 2>&1
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
    # Resolve workspace:* references to actual version before publishing
    - |
      VERSION="${CI_COMMIT_TAG#v}"
      echo "Publishing version ${VERSION}"
      for pkg in core fastify express hono cli; do
        dir="packages/${pkg}"
        echo "--- ${dir} ---"
        cd "${dir}"
        jq --arg v "${VERSION}" '.version = $v' package.json > tmp.json && mv tmp.json package.json
        jq --arg v "${VERSION}" '
          if .dependencies then
            .dependencies |= with_entries(
              if .value == "workspace:*" then .value = $v else . end
            )
          else . end
        ' package.json > tmp.json && mv tmp.json package.json
        npm publish --access public || echo "Skipped ${pkg} (may already exist)"
        cd "${CI_PROJECT_DIR}"
      done

# ---------------------------------------------------------------------------
# Sync to GitHub (on pushes to main)
# ---------------------------------------------------------------------------
sync:github:
  stage: sync
  tags:
    - main
  image: alpine:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+/
  script:
    - apk add --no-cache git
    - git clone --mirror "${CI_REPOSITORY_URL}" repo.git
    - cd repo.git
    - git remote add github "https://${GITHUB_TOKEN}@github.com/${GITHUB_REPO}.git"
    - git push github --mirror --force
